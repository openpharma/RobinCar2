---
title: "Design for covadj"
author: "Liming Li"
output: html_document
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Objective

The objective is to create a package to include commonly used covariate adjusted analysis method in clinical trials, according to [FDA guidance on adjusting covariates](https://www.fda.gov/regulatory-information/search-fda-guidance-documents/adjusting-covariates-randomized-clinical-trials-drugs-and-biological-products).

# Linear models

Linear models are described in section III.B.

1. Use linear model, include treatment, covariates, intercept with ordinary least square estimator.
1. Average treatment effect can be robustly obtained.
1. Robust variance should be used in case of model mis-specification(Huber-White sandwich standard error).
1. If model includes treatment * covariate interaction, can adopt other robust standard error methods, or using bootstrapping.
1. Standard error computation best combined with stratification, covariate adjustment and model misspecification.

# Non-linear models

1. Non-collapsibility is a big issue for non-linear models.
1. HR, OR are usually non-collapsible, while risk difference and RR are collapsible.
1. CMH is acceptable if conditional treatment effect is of interest.
1. Covariate adjusted unconditional treatment effect can also be infered, using bootstrapping or statistically reliable methods published.
1. standardization method is one possible reliable method.
1. IPTW is also one reliable method.
1. standard error also best if stratification taken into consideration.

# Implementation of standardization method for linear models

The function name is `std_lm`, and the arguments are quite similar to `lm`.
For now at least we choose `vcovHC()` as default

```
std_lm(formula, data, trt_var, ...)
```

The class of the fit is `std_lm`, it contains the fit object itself.

`trteatment_effect` is a generic to obtain the marginal treatment effect and its covariance.
In `std_lm` or `std_glm`, the "link" is obtained and then apply with the link function to obtain
the final estimator.
The derivative of the link functions will be used in sandwich method. The meat part of the sandwich
is the robust covariance.

## Weights in these models

For standardization methods, weights should not be used; only for weighting methods we can provide
some weights function that produce weights for each observations, like `iptw` methods.
This is also recommented by FDA.

In implementation of this, consider use a wrapper with similar arguments of the standardization methods.
To simplify the process, we should not do it in two steps, obtaining the weight and then give the weights to
the regression functions.

# deciding the treatment variable

To decide which treatment variable should be used, there are two approaches:

1. specify in formula. `Response ~ trt(trt_var) + .`
1. specify in a separate argument.

The latter approach is much simpler and is adopted.

# deciding the levels of treatment variable

In general, to obtain the treatment effect, the treatment variable is binary.
However, if there are multiple arms, there are some method to contruct the estimated
treatment effect.
